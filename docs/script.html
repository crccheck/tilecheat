<!DOCTYPE html>  <html> <head>   <title>script.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="script.html">                 script.coffee               </a>                                           <a class="source" href="solver.creeper.html">                 solver.creeper.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               script.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>CONFIGURATION</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">defaultOptions =</span>
  <span class="nv">draw_delay: </span><span class="mi">0</span>
<span class="nv">n_slices = </span><span class="mi">4</span>
<span class="nv">retries = </span><span class="mi">0</span>
<span class="nv">vignette_fix = </span><span class="mi">1</span>  <span class="c1"># black levels below this will have noise artificially added</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>coffeescript scope hack</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">slice_w = </span><span class="mi">0</span>
<span class="nv">width = </span><span class="mi">0</span>
<span class="nv">_srcImg = </span><span class="s">&quot;&quot;</span>
<span class="nv">_dstCanvas = </span><span class="s">&quot;&quot;</span>
<span class="nv">_options = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Interacting with a pixel array</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Get the color information about a coordinate <code>x</code>, <code>y</code> in pixel array <code>d</code>.
Instead of using RGB from the raw data, use LAB by default since working in a
colorspace that mimics human perception yields better results.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getPixel = </span><span class="nf">(d, x, y) -&gt;</span>
  <span class="nv">index = </span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
  <span class="nv">rgb =</span>
    <span class="nv">r: </span><span class="nx">d</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
    <span class="nv">g: </span><span class="nx">d</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nv">b: </span><span class="nx">d</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
  <span class="nv">lab = </span><span class="nx">Color</span><span class="p">.</span><span class="nx">convert</span><span class="p">(</span><span class="nx">rgb</span><span class="p">,</span> <span class="s">&quot;lab&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">lab</span><span class="p">.</span><span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">vignette_fix</span>
    <span class="nv">lab.l = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">lab</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>For debugging, replace <code>getPixel</code> with this to see which pixels are actually
getting touched by <code>getPixel</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">setPixel = </span><span class="nf">(d, x, y) -&gt;</span>
  <span class="nv">index = </span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
  <span class="nv">rgba = </span><span class="p">[</span><span class="nx">d</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span>
  <span class="nx">d</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">d</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">d</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="nx">d</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Get the top <code>n</code>, right <code>e</code>, bottom <code>s</code>, and left <code>w</code> description of a slice
of imageData <code>d</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getEdgeData = </span><span class="nf">(d, x, y) -&gt;</span>
  <span class="nv">x_begin = </span><span class="nx">x</span> <span class="o">*</span> <span class="nx">slice_w</span>
  <span class="nv">x_end = </span><span class="nx">x_begin</span> <span class="o">+</span> <span class="nx">slice_w</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="nv">y_begin = </span><span class="nx">y</span> <span class="o">*</span> <span class="nx">slice_w</span>
  <span class="nv">y_end = </span><span class="nx">y_begin</span> <span class="o">+</span> <span class="nx">slice_w</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="nv">data =</span>
    <span class="nv">id: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">x</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">y</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">grid:</span>
      <span class="nv">x: </span><span class="nx">x</span>
      <span class="nv">y: </span><span class="nx">y</span>
    <span class="nv">n: </span><span class="p">[]</span>
    <span class="nv">s: </span><span class="p">[]</span>
    <span class="nv">e: </span><span class="p">[]</span>
    <span class="nv">w: </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">x_begin</span><span class="p">..</span><span class="nx">x_end</span><span class="p">]</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getPixel</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">y_begin</span><span class="p">)</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getPixel</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">y_end</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">y_begin</span><span class="p">..</span><span class="nx">y_end</span><span class="p">]</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getPixel</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">x_begin</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">w</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getPixel</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">x_end</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">data</span>


<span class="nv">getEdgeComplexity = </span><span class="nf">(edge) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>quantitize array using bitshifting
only look at luminance (L) channel</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">simplified = </span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">l</span><span class="o">&gt;&gt;</span><span class="mi">3</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">edge</span><span class="p">)</span>
  <span class="nv">entropy = </span><span class="mi">0</span>
  <span class="nv">last = </span><span class="kc">undefined</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">simplified</span>
    <span class="k">if</span> <span class="nx">x</span> <span class="o">!=</span> <span class="nx">last</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>TODO add more entropy for bigger jumps</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">entropy</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="nv">last = </span><span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>entropy will be >= 1</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">entropy</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>get the distance between two edges</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">distance = </span><span class="nf">(d1, d2) -&gt;</span>
  <span class="nv">sum = </span><span class="mi">0</span>
  <span class="nv">entropy1 = </span><span class="nx">getEdgeComplexity</span><span class="p">(</span><span class="nx">d1</span><span class="p">)</span>
  <span class="nv">entropy2 = </span><span class="nx">getEdgeComplexity</span><span class="p">(</span><span class="nx">d2</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">color1</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">d1</span>
    <span class="nv">color2 = </span><span class="nx">d2</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span>
    <span class="nx">sum</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">color2</span><span class="p">.</span><span class="nx">l</span> <span class="o">-</span> <span class="nx">color1</span><span class="p">.</span><span class="nx">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nx">sum</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">color2</span><span class="p">.</span><span class="nx">a</span> <span class="o">-</span> <span class="nx">color1</span><span class="p">.</span><span class="nx">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nx">sum</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">color2</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">color1</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span> <span class="nx">sum</span> <span class="o">/</span> <span class="nx">entropy1</span> <span class="o">/</span> <span class="nx">entropy2</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>make sure the top left is at 0.0</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">normalizeResultGrid = </span><span class="nf">(input) -&gt;</span>
  <span class="nv">minX = </span><span class="mi">99</span>
  <span class="nv">minY = </span><span class="mi">99</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">input</span>
    <span class="nv">bits = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="nv">minX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minX</span><span class="p">,</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nv">minY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minY</span><span class="p">,</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="nv">newObj = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">input</span>
    <span class="nv">bits = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="nx">newObj</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">minX</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">minY</span><span class="si">}</span><span class="s">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
  <span class="k">return</span> <span class="nx">newObj</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>get the shape of a grid</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">shape = </span><span class="nf">(input) -&gt;</span>
  <span class="nv">minX = </span><span class="mi">99</span>
  <span class="nv">minY = </span><span class="mi">99</span>
  <span class="nv">maxX = </span><span class="o">-</span><span class="mi">99</span>
  <span class="nv">maxY = </span><span class="o">-</span><span class="mi">99</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">input</span>
    <span class="nv">bits = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="nv">minX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minX</span><span class="p">,</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nv">maxX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">maxX</span><span class="p">,</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nv">minY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minY</span><span class="p">,</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nv">maxY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">maxY</span><span class="p">,</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">maxX</span> <span class="o">-</span> <span class="nx">minX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">maxY</span> <span class="o">-</span> <span class="nx">minY</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>get edge data from the raw image data</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getAllEdgeData = </span><span class="nf">(imageDataArray) -&gt;</span>
  <span class="nv">edgeData = </span><span class="p">[]</span>
  <span class="nv">slices = </span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n_slices</span> <span class="o">*</span> <span class="nx">n_slices</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">slices</span>
    <span class="nv">row = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">i</span> <span class="o">/</span> <span class="nx">n_slices</span><span class="p">)</span>
    <span class="nv">col = </span><span class="nx">i</span> <span class="o">%</span> <span class="nx">n_slices</span>
    <span class="nx">edgeData</span><span class="p">.</span><span class="nx">push</span> <span class="nx">getEdgeData</span><span class="p">(</span><span class="nx">imageDataArray</span><span class="p">,</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">edgeData</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>test if the result grid is a valid solution</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">resultIsValid = </span><span class="nf">(resultGrid) -&gt;</span>
  <span class="nv">dim = </span><span class="nx">shape</span><span class="p">(</span><span class="nx">resultGrid</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">n_slices</span> <span class="o">and</span> <span class="nx">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">n_slices</span>


<span class="nv">drawGrid = </span><span class="nf">(grid, srcImg=_srcImg, dstCanvas=_dstCanvas) -&gt;</span>
  <span class="nv">width = height = </span><span class="nx">img</span><span class="p">.</span><span class="nx">width</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>clear canvas, resize if necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dim = </span><span class="nx">shape</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span>
  <span class="nv">dstCanvas.width = </span><span class="nx">width</span> <span class="o">*</span> <span class="nx">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nx">n_slices</span>
  <span class="nv">dstCanvas.height = </span><span class="nx">height</span> <span class="o">*</span> <span class="nx">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nx">n_slices</span>
  <span class="nv">c = </span><span class="nx">dstCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>c.clearRect(0, 0, canvas.width, canvas.height)  # alternate</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>draw unscrambled image</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mapping = </span><span class="nx">normalizeResultGrid</span> <span class="nx">grid</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">dTile</span><span class="p">,</span> <span class="nx">sTile</span> <span class="k">of</span> <span class="nx">mapping</span>
    <span class="nv">sBits = </span><span class="nx">sTile</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="nv">dBits = </span><span class="nx">dTile</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">srcImg</span><span class="p">,</span>
      <span class="nx">sBits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">slice_w</span><span class="p">,</span> <span class="nx">sBits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">slice_w</span><span class="p">,</span> <span class="nx">slice_w</span><span class="p">,</span> <span class="nx">slice_w</span><span class="p">,</span>
      <span class="nx">dBits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">slice_w</span><span class="p">,</span> <span class="nx">dBits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">slice_w</span><span class="p">,</span> <span class="nx">slice_w</span><span class="p">,</span> <span class="nx">slice_w</span><span class="p">)</span>


<span class="nv">exports = </span><span class="k">this</span>


<span class="nv">exports.descrambleImg = </span><span class="nf">(img, options) -&gt;</span>
  <span class="nx">extend</span> <span class="nx">_options</span><span class="p">,</span> <span class="nx">defaultOptions</span>
  <span class="nx">extend</span> <span class="nx">_options</span><span class="p">,</span> <span class="nx">options</span>
  <span class="nv">_srcImg = </span><span class="nx">img</span>
  <span class="nv">width = height = </span><span class="nx">img</span><span class="p">.</span><span class="nx">width</span>
  <span class="nv">slice_w = </span><span class="nx">width</span> <span class="o">/</span> <span class="nx">n_slices</span>

  <span class="nv">_dstCanvas = canvas = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;canvas&#39;</span><span class="p">);</span>
  <span class="nv">canvas.width = </span><span class="nx">width</span>
  <span class="nv">canvas.height = </span><span class="nx">height</span>
  <span class="nv">c = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span>

  <span class="nv">imageData = </span><span class="nx">c</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span>
  <span class="nv">edgeData = </span><span class="nx">getAllEdgeData</span> <span class="nx">imageData</span><span class="p">.</span><span class="nx">data</span>

  <span class="nv">_retries = </span><span class="nx">retries</span>
  <span class="nv">resultGrid = </span><span class="nx">getResult2</span><span class="p">(</span><span class="nx">edgeData</span><span class="p">)</span>
  <span class="k">while</span> <span class="nx">_retries</span><span class="o">--</span> <span class="o">and</span> <span class="o">!</span><span class="nx">resultIsValid</span><span class="p">(</span><span class="nx">resultGrid</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;try again, attempt </span><span class="err">#</span><span class="si">#{</span><span class="nx">retries</span> <span class="o">-</span> <span class="nx">_retries</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">resultGrid = </span><span class="nx">getResult2</span><span class="p">(</span><span class="nx">edgeData</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="nx">_options</span><span class="p">.</span><span class="nx">draw_delay</span>
    <span class="nx">drawGrid</span><span class="p">(</span><span class="nx">resultGrid</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">canvas</span>


<span class="nv">exports.main = </span><span class="o">-&gt;</span>
  <span class="nv">img = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;img&#39;</span><span class="p">)</span>
  <span class="nv">canvas = </span><span class="nx">descrambleImg</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>
  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;canvas-container&#39;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span>
  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;go&#39;</span><span class="p">).</span><span class="nv">onclick = </span><span class="o">-&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;canvas-container&#39;</span><span class="p">).</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span>
    <span class="nv">canvas = </span><span class="nx">descrambleImg</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="p">{</span>
        <span class="nv">draw_delay: </span><span class="mi">500</span>
      <span class="p">})</span>
    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;canvas-container&#39;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 